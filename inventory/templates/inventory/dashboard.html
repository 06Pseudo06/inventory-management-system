{% extends "inventory/base.html" %}

{% block content %}
<h1>Dashboard</h1>

<div class="stats">
    <div>Total Items: <strong>{{ total_items }}</strong></div>
    <div>Active Items: <strong>{{ active_items }}</strong></div>
    <div>Low Stock Items: <strong>{{ low_stock_items|length }}</strong></div>
</div>

<hr>

<h2>Low Stock Items</h2>
{% if low_stock_items %}
<table>
    <tr>
        <th>Name</th>
        <th>Quantity</th>
        <th>Min Threshold</th>
    </tr>
    {% for item in low_stock_items %}
    <tr class="low-stock">
        <td>{{ item.name }}</td>
        <td>{{ item.quantity }}</td>
        <td>{{ item.min_threshold }}</td>
    </tr>
    {% endfor %}
</table>
{% else %}
<p>No low-stock items ðŸŽ‰</p>
{% endif %}

<hr>

{% if low_stock_items %}
<h2>Stock Levels</h2>
<canvas id="stockChart" height="100"></canvas>

{{ stock_chart_data|json_script:"stock-data" }}

{% endif %}

<hr>

<h2>Recent Transactions</h2>
{% if recent_transactions %}
<table>
    <tr>
        <th>Type</th>
        <th>Item</th>
        <th>Qty</th>
        <th>User</th>
        <th>Date</th>
    </tr>
    {% for txn in recent_transactions %}
    <tr>
        <td>
            {% if txn.transaction_type == "IN" %}
                <span class="badge-in">IN</span>
            {% else %}
                <span class="badge-out">OUT</span>
            {% endif %}
        </td>
        <td>{{ txn.item.name }}</td>
        <td>{{ txn.quantity }}</td>
        <td>{{ txn.performed_by }}</td>
        <td>{{ txn.created_at|date:"Y-m-d H:i" }}</td>
    </tr>
    {% endfor %}
</table>
{% else %}
<p>No transactions yet.</p>
{% endif %}
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>

<script>
const dataElement = document.getElementById("stock-data");
const ctx = document.getElementById("stockChart");

if (dataElement && ctx) {
    const items = JSON.parse(dataElement.textContent);

    new Chart(ctx, {
        type: "bar",
        data: {
            labels: items.map(item => item.name),
            datasets: [{
                label: "Quantity",
                data: items.map(item => item.quantity),
                backgroundColor: "#4f46e5"
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false }
            }
        }
    });
}
</script>
{% endblock %}
