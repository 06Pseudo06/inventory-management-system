{% extends "inventory/base.html" %}

{% block content %}
<div class="dashboard">

<h1>Inventory Dashboard</h1>

<!-- ================= Stats ================= -->
<div class="stats">
    <div class="stat-card">
        <span>Total Items</span>
        <strong>{{ total_items }}</strong>
    </div>
    <div class="stat-card">
        <span>Active Items</span>
        <strong>{{ active_items }}</strong>
    </div>
    <div class="stat-card">
        <span>Low Stock</span>
        <strong>{{ low_stock_items|length }}</strong>
    </div>
</div>

<hr>

<!-- ================= Low Stock ================= -->
<h2>Low Stock Items</h2>

{% if low_stock_items %}
<div class="low-stock-section">
    <table class="table low-stock-table">
        <thead>
            <tr>
                <th>Name</th>
                <th>Quantity</th>
                <th>Min Threshold</th>
            </tr>
        </thead>
        <tbody>
            {% for item in low_stock_items %}
            <tr class="low-stock">
                <td>{{ item.name }}</td>
                <td>{{ item.quantity }}</td>
                <td>{{ item.min_threshold }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<p>No low-stock items.</p>
{% endif %}

<hr>

<!-- ================= Stock Chart ================= -->
<h2>Stock Levels (All Items)</h2>
<canvas id="stockChart" width="600" height="300"></canvas>
{{ stock_chart_data|json_script:"stock-data" }}

<hr>

<!-- ================= Transactions ================= -->
<h2>Recent Transactions</h2>

{% if recent_transactions %}
<table class="txn-table">
    <thead>
        <tr>
            <th>Type</th>
            <th>Item</th>
            <th>Quantity</th>
            <th>User</th>
            <th>Date</th>
        </tr>
    </thead>
    <tbody>
        {% for txn in recent_transactions %}
        <tr>
            <td>
                {% if txn.transaction_type == "IN" %}
                    <span class="txn-badge in">IN</span>
                {% else %}
                    <span class="txn-badge out">OUT</span>
                {% endif %}
            </td>
            <td>{{ txn.item.name }}</td>
            <td>{{ txn.quantity }}</td>
            <td>{{ txn.performed_by }}</td>
            <td>{{ txn.created_at|date:"d M Y, H:i" }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

{% else %}
<p>No transactions yet.</p>
{% endif %}

</div>  <!-- âœ… dashboard wrapper closed properly -->
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>

<script>
(function () {
    const dataEl = document.getElementById("stock-data");
    const canvas = document.getElementById("stockChart");

    if (!dataEl || !canvas) return;

    const items = JSON.parse(dataEl.textContent);
    if (!items.length) return;

    new Chart(canvas, {
        type: "bar",
        data: {
            labels: items.map(i => i.name),
            datasets: [{
                data: items.map(i => i.quantity),
                backgroundColor:  "#97BEDB",
                borderColor: "#022C4A",
                borderWidth: 1,
                borderRadius: 6,
                hoverBackgroundColor: "#376482"
            }]
        },
        options: {
            responsive: false,
            animation: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: "#111827",
                    padding: 10
                }
            },
            scales: {
                x: { ticks: { color: "#374151" } },
                y: {
                    beginAtZero: true,
                    ticks: { color: "#374151" }
                }
            }
        }
    });
})();
</script>
{% endblock %}
